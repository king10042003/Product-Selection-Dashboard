<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="w</div>idth=device-width, initial-scale=1.0">
  <title>Product Selection Dashboard</title>
  <!-- Link to your external CSS file located in static/style.css -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Include jQuery for convenience -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="paper">
    <h1>Product Selection Dashboard</h1>
    
    <div class="dashboard-header">
      <!-- Filter Section -->
      <div id="filter-section" class="p-4">
        <div class="filter-controls">
          <label for="column-select" class="form-label">Choose Column:</label>
          <select id="column-select" class="form-select">
        {% for col in column_data %}
          <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
          </select>
        </div>
      
        <div id="filter-options-container" class="mt-3">
          <!-- Filter options container with scrollable area -->
          <div class="options-list" style="max-height: 500px; 
               width: 100%;
               overflow-y: auto; 
               border: 1px solid #ccc; 
               padding: 8px; 
               border-radius: 4px;
               background: #fff;
               box-shadow: inset 0 0 4px rgba(0,0,0,0.1);">
          </div>
        </div>
          

      </div>
      <form action="/" method="POST" enctype="multipart/form-data" class="mb-4">
        <label class="block mb-2">Upload CSV File:</label>
        <input type="file" name="file" required class="mb-2">
        <button type="submit" class="btn-primary" onclick="localStorage.removeItem('selectedItems');">Upload CSV</button>
        <a href="{{ url_for('download_sample') }}" class="btn-secondary inline-block mb-4" download>
          ðŸ“¥ Download Sample CSV
        </a>
      </form>
        <!-- AG Summary Panel Toggle Button -->
      <div class="summary-toggle">
        <button class="btn-primary" id="toggle-ag-panel">Show AG Summary</button>
      </div>
      
      <!-- AG Summary Panel: floating and hidden by default -->
      <div class="ag-floating-panel hidden" id="ag-summary-panel">
        <h3>Selected Count by AG</h3>
        <div class="summary-content">
          <table class="ag-summary-table">
            <thead>
              <tr>
                <th>AG</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody id="ag-summary-table">
              <!-- The table content will be dynamically generated by JavaScript -->
              <tr>
                <td colspan="2" style="text-align: center;">No items selected</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="summary-actions">
          <button class="btn-primary mt-2" id="refresh-ag-summary">Refresh</button>
          <button class="btn-secondary mt-2" id="close-ag-panel">Close</button>
        </div>
      </div>
      

    

    <hr class="my-4" style="width: 50%; margin: 2rem auto;">

    <!-- Product List -->
    <ul class="card-list">
      {% for item in data %}
        <li class="paper border shadow shadow-large shadow-hover" data-ag="{{ item['AG'] }}">
          <input type="checkbox" class="select-item" data-item="{{ item['Item Code'] }}"
            {% if item['Item Code'] in selected_items %}checked{% endif %}>
          <img src="{{ item['IMAGE'] }}" alt="Product Image" onerror="this.onerror=null; this.src='https://via.placeholder.com/150';">
          <h2>Item Code: {{ item['Item Code'] }}</h2>
          <p>AG: {{ item['AG'] }}</p>
          <p>Unit Weight: {{ item['Unit Weight'] }}</p>
          <p>Complexity: {{ item['Complexity Code'] }}</p>
          <p>Group: {{ item['Product Group'] }}</p>
          <p>Stock Value: {{ item['Stock Value'] }}</p>
          <p>Category: {{ item['Product Category Description'] }}</p>
          
          <!-- ðŸ”½ Dropdown for status -->
          <!-- Update this part in your template where you render the dropdown -->
          <div class="status-wrapper" style="margin-top: 10px;">
            <label for="status-{{ loop.index }}">Status: </label>
            <select name="status-{{ loop.index }}" class="status-dropdown" style="margin-left: 5px;" 
                    data-item="{{ item['Item Code'] }}" data-preset-value="{{ item['status'] }}">
              <option value="none">none</option>
              <option value="MTAR">MTAR</option>
              <option value="S-NPI">S-NPI</option>
              <option value="R-NPI">R-NPI</option>
              <option value="IN-ACTIVE">IN-ACTIVE</option>
            </select>
          </div>
          <!-- ðŸ”¼ End of Dropdown for status -->
        </li>
      {% endfor %}
    </ul>
    
  </div>
  
  <hr>

  <!-- Pagination Controls -->
  <div class="pagination-controls">
    <div class="pagination">
      {% if current_page > 1 %}
        <a href="{{ url_for('dashboard', page=current_page-1, filter_col=request.args.get('filter_col'), filter_val=request.args.get('filter_val')) }}" 
          class="btn-secondary" 
          title="Go to previous page" 
          aria-label="Previous Page">Previous</a>
      {% endif %}

      <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>

      {% if current_page < total_pages %}
        <a href="{{ url_for('dashboard', page=current_page+1, filter_col=request.args.get('filter_col'), filter_val=request.args.get('filter_val')) }}" 
          class="btn-primary" 
          title="Go to next page" 
          aria-label="Next Page">Next</a>
      {% endif %}
    </div>
  </div>

  <!-- Download Selected Button -->
  <button id="downloadSelected" class="btn-primary">Download Selected Products</button>

  <hr>

  <!-- Fix for the AG Summary Panel update -->
  <!-- Hidden elements for server data -->
  <script id="column-data" type="application/json">{{ column_data | tojson | safe }}</script>
  {% if dropdown_status is defined %}
  <script id="dropdown-status" type="application/json">{{ dropdown_status | tojson | safe }}</script>
  {% endif %}

  <script>
  document.addEventListener("DOMContentLoaded", function() {
    // Core element references
    const agPanel = document.getElementById('ag-summary-panel');
    const toggleBtn = document.getElementById('toggle-ag-panel');
    const closeBtn = document.getElementById('close-ag-panel');
    const refreshBtn = document.getElementById('refresh-ag-summary');
    const downloadBtn = document.getElementById('downloadSelected');
    const columnDropdown = document.getElementById('column-select');
    const filterOptionsContainer = document.getElementById('filter-options-container');

    // Initialize data
    let selectedItems = new Set(JSON.parse(localStorage.getItem("selectedItems") || "[]"));
    let itemStatuses = JSON.parse(localStorage.getItem("itemStatuses") || "{}");

    // Load server status
    const statusElement = document.getElementById('dropdown-status');
    if (statusElement) {
      try {
        const serverStatuses = JSON.parse(statusElement.textContent);
        itemStatuses = { ...itemStatuses, ...serverStatuses };
        localStorage.setItem("itemStatuses", JSON.stringify(itemStatuses));
      } catch (e) {
        console.error("Error loading server statuses:", e);
      }
    }

    // Panel controls
    toggleBtn?.addEventListener('click', () => {
      agPanel.classList.toggle('visible');
      if (agPanel.classList.contains('visible')) updateAGSummary();
    });

    closeBtn?.addEventListener('click', () => agPanel.classList.remove('visible'));
    refreshBtn?.addEventListener('click', updateAGSummary);

    // Checkbox handling
    document.querySelectorAll(".select-item").forEach(checkbox => {
      const itemCode = checkbox.dataset.item;
      checkbox.checked = selectedItems.has(itemCode);
      
      checkbox.addEventListener("change", function() {
        if (this.checked) {
          selectedItems.add(itemCode);
        } else {
          selectedItems.delete(itemCode);
        }
        localStorage.setItem("selectedItems", JSON.stringify([...selectedItems]));
        updateAGSummary();

        fetch("/save_selection", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ selected: [...selectedItems] })
        })
        .then(res => res.json())
        .catch(err => console.error("Error saving selection:", err));
      });
    });

    // Status dropdown handling
    document.querySelectorAll(".status-dropdown").forEach(dropdown => {
      const itemCode = dropdown.dataset.item;
      const preset = dropdown.dataset.presetValue;
      dropdown.value = preset && preset !== "none" ? preset : (itemStatuses[itemCode] || "none");

      dropdown.addEventListener("change", function() {
        itemStatuses[itemCode] = this.value;
        localStorage.setItem("itemStatuses", JSON.stringify(itemStatuses));

        fetch("/save_status", {
          method: "POST", 
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ item_code: itemCode, status: this.value })
        })
        .then(res => res.json())
        .catch(err => console.error("Error saving status:", err));
      });
    });

    // Download functionality
    downloadBtn?.addEventListener("click", () => {
      window.location.href = "/download_selected";
    });

    // Column filter functionality
    if (columnDropdown) {
      columnDropdown.addEventListener("change", loadFilterOptions);
    }

    function loadFilterOptions() {
      const selectedColumn = columnDropdown.value;
      if (!selectedColumn) return;

      fetch(`/get_unique_values?column=${encodeURIComponent(selectedColumn)}`)
        .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
        .then(data => {
          renderFilterOptions(data.values || [], selectedColumn);
        })
        .catch(err => {
          filterOptionsContainer.innerHTML = `<p class="text-danger">Error: ${err}</p>`;
        });
    }

    function updateAGSummary() {
      const summaryTable = document.getElementById('ag-summary-table');
      if (!selectedItems.size) {
        summaryTable.innerHTML = '<tr><td colspan="2" style="text-align:center;">No items selected</td></tr>';
        return;
      }

      fetch("/get_selected_ag_data")
        .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
        .then(data => {
          if (!data.ag_counts) throw new Error("No AG data");
          renderAGSummary(data.ag_counts);
        })
        .catch(err => {
          summaryTable.innerHTML = `<tr><td colspan="2" style="color:red;">Error: ${err}</td></tr>`;
        });
    }

    // Initialize summary
    updateAGSummary();
  });

  // Helper functions
  function renderFilterOptions(values, selectedColumn) {
    const container = document.querySelector('.options-list');
    container.innerHTML = `
      <input type="text" id="filter-search" placeholder="Search values..." class="form-control mb-2">
      <div id="filter-values-list" class="options-list" style="max-height: 300px; overflow-y: auto;">
        ${values.map((val, i) => `
          <div class="checkbox-wrapper">
            <input type="checkbox" id="filter-val-${i}" value="${val}" name="${selectedColumn}">
            <label for="filter-val-${i}">${val}</label>
          </div>
        `).join('')}
      </div>
    `;

    // Move buttons outside the scrollable area
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'filter-actions mt-2';
    buttonContainer.innerHTML = `
      <button id="apply-filter" class="btn-primary" disabled>Apply Filter</button>
      <button class="btn-secondary" onclick="uncheckAllFilters()">Clear Selection</button>
      <button class="btn-secondary" onclick="clearFilter()">Clear Filter</button>
    `;
    container.parentNode.appendChild(buttonContainer);

    setupFilterHandlers();
  }

  function setupFilterHandlers() {
    const searchInput = document.getElementById('filter-search');
    const checkboxes = document.querySelectorAll('#filter-values-list input[type="checkbox"]');
    const applyButton = document.getElementById('apply-filter');

    // Enable/disable apply button based on checkbox selection
    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        applyButton.disabled = ![...checkboxes].some(cb => cb.checked);
      });
    });

    // Handle search filtering
    searchInput?.addEventListener('input', (e) => {
      const searchText = e.target.value.toLowerCase();
      document.querySelectorAll('.checkbox-wrapper').forEach(wrapper => {
        const label = wrapper.querySelector('label').textContent.toLowerCase();
        wrapper.style.display = label.includes(searchText) ? '' : 'none';
      });
    });

    // Handle apply button click
    applyButton?.addEventListener('click', () => {
      const selectedColumn = document.getElementById('column-select').value;
      const selectedValues = [...checkboxes]
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      if (selectedValues.length) {
        const params = new URLSearchParams({
          filter_col: selectedColumn,
          filter_val: selectedValues.join(',')
        });
        window.location.href = `/dashboard?${params.toString()}`;
      }
    });
  }

  function renderAGSummary(agCounts) {
    const summaryTable = document.getElementById('ag-summary-table');
    let total = 0;
    let html = '';

    for (const [ag, count] of Object.entries(agCounts)) {
      html += `<tr><td>${ag}</td><td>${count}</td></tr>`;
      total += count;
    }

    html += `
      <tr><td colspan="2"><hr></td></tr>
      <tr class="total-row">
        <td><strong>Total Selected:</strong></td>
        <td><strong>${total}</strong></td>
      </tr>
    `;

    summaryTable.innerHTML = html;
  }

  // Global functions
  window.clearFilter = () => window.location.href = "/dashboard";
  window.uncheckAllFilters = () => {
    document.querySelectorAll("#filter-values-list input[type='checkbox']").forEach(cb => cb.checked = false);
    document.getElementById("apply-filter").disabled = true;
  };
  </script>
    
  
  
</body>
</html>