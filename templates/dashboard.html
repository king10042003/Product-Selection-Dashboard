<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Selection Dashboard</title>
  <!-- Link to your external CSS file located in static/style.css -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Include jQuery for convenience -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="paper">
    <h1>Product Selection Dashboard</h1>
    
    <div class="dashboard-header">
      <div id="filter-section" class="p-4">
        <label for="column-select">Choose Column:</label>
        <select id="column-select">
          <!-- Column options will be dynamically inserted here -->
        </select>
  
        <div id="filter-options-container" class="mt-2">
          <input type="text" id="filter-search" placeholder="Search values..." class="mb-2" oninput="filterValueOptions()" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
        
          <div id="filter-options" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; border-radius: 4px;">
            <!-- Checkboxes will be dynamically inserted here -->
          </div>
        
          <button id="apply-filter" onclick="applyFilter()" class="btn-primary mt-2" disabled>Apply Filter</button>
          <button type="button" class="btn-secondary mt-2" onclick="uncheckAllFilters()">Clear All</button>
          
          <button onclick="clearFilter()" class="btn-secondary mt-2">Clear Filter</button>
        </div>
    </div>
  
    <div class="right-panel">
      <h2>Selected Products</h2>
      <p id="selected-count">0</p>
    </div>
    
  
    
  
    <form action="/" method="POST" enctype="multipart/form-data" class="mb-4">
      <label class="block mb-2">Upload CSV File:</label>
      <input type="file" name="file" required class="mb-2">
      <button type="submit" class="btn-primary" onclick="localStorage.removeItem('selectedItems');">Upload CSV</button>
      <a href="{{ url_for('download_sample') }}" class="btn-secondary inline-block mb-4" download>
        ðŸ“¥ Download Sample CSV
      </a>
    </form>
  
      
    <hr class="my-4" style="width: 50%; margin: 2rem auto;">
  
    <!-- Product List -->
    <ul class="card-list">
      {% for item in data %}
      <li class="paper border shadow shadow-large shadow-hover">
        <input type="checkbox" class="select-item" data-item="{{ item['Item Code'] }}"
          {% if item['Item Code'] in selected_items %}checked{% endif %}>
        <img src="{{ item['IMAGE'] }}" alt="Product Image" onerror="this.onerror=null; this.src='https://via.placeholder.com/150';">
        <h2>Item Code: {{ item['Item Code'] }}</h2>
        <p>Lot: {{ item['Lot Number'] }}</p>
        <p>Unit Weight: {{ item['Unit Weight'] }}</p>
        <p>Complexity: {{ item['Complexity Code'] }}</p>
        <p>Group: {{ item['Product Group'] }}</p>
        <p>Stock Value: {{ item['Stock Value'] }}</p>
        <p>Category: {{ item['Product Category Description'] }}</p>
      </li>
      {% endfor %}
    </ul>
  
    <hr>
  
        <!-- Pagination Controls -->
        <!-- Pagination Controls -->
    <div class="pagination-controls">
      <div class="pagination">
        {% if current_page > 1 %}
          <a href="{{ url_for('dashboard', page=current_page-1, filter_col=request.args.get('filter_col'), filter_val=request.args.get('filter_val')) }}" 
            class="btn-secondary" 
            title="Go to previous page" 
            aria-label="Previous Page">Previous</a>
        {% endif %}

        <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>

        {% if current_page < total_pages %}
          <a href="{{ url_for('dashboard', page=current_page+1, filter_col=request.args.get('filter_col'), filter_val=request.args.get('filter_val')) }}" 
            class="btn-primary" 
            title="Go to next page" 
            aria-label="Next Page">Next</a>
        {% endif %}
      </div>
    </div>

    <!-- Download Selected Button -->
    <button id="downloadSelected" class="btn-primary">Download Selected Products</button>

  
    <hr>
  
    
  </div>

  <script>
    // Injected from Flask
    const columnData = JSON.parse('{{ column_data | tojson | safe }}');
    console.log("Available Columns:", columnData);
  
    document.addEventListener("DOMContentLoaded", function () {
      const selectedItems = new Set(JSON.parse(localStorage.getItem("selectedItems")) || []);
      const applyButton = document.getElementById("apply-filter");
      const columnDropdown = document.getElementById("column-select");
      const filterOptionsContainer = document.getElementById("filter-options");
      const filterSearch = document.getElementById("filter-search");
      const downloadBtn = document.getElementById("downloadSelected");
      const selectedCountEl = document.getElementById('selected-count');
  
      if (applyButton) applyButton.disabled = true;
  
      // Populate column dropdown
      if (columnDropdown) {
        columnData.forEach(col => {
          const option = document.createElement("option");
          option.value = col;
          option.textContent = col;
          columnDropdown.appendChild(option);
        });
        columnDropdown.addEventListener("change", loadFilterOptions);
      }
  
      // Restore checkbox state and count
      updateCount(selectedItems.size);
      document.querySelectorAll(".select-item").forEach((checkbox) => {
        const itemCode = checkbox.getAttribute("data-item");
        if (selectedItems.has(itemCode)) checkbox.checked = true;
  
        checkbox.addEventListener("change", function () {
          if (this.checked) {
            selectedItems.add(itemCode);
          } else {
            selectedItems.delete(itemCode);
          }
          localStorage.setItem("selectedItems", JSON.stringify([...selectedItems]));
  
          fetch("{{ url_for('save_selection') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ selected: [...selectedItems] })
          })
            .then(res => res.json())
            .then(data => {
              console.log("Selection saved:", data.message);
              if (data.selectedCount) updateCount(data.selectedCount);
            })
            .catch(err => console.error("Error saving selection:", err));
        });
      });
  
      // Download Selected Button
      if (downloadBtn) {
        downloadBtn.addEventListener("click", function () {
          window.location.href = "{{ url_for('download_selected') }}";
        });
      }
  
      // Hover Blur Effect
      const cardList = document.querySelector(".card-list");
      const listItems = document.querySelectorAll(".card-list li");
      listItems.forEach((item) => {
        item.addEventListener("mouseover", function () {
          cardList.classList.add("hover-active");
          item.classList.add("hovered");
        });
        item.addEventListener("mouseleave", function () {
          cardList.classList.remove("hover-active");
          item.classList.remove("hovered");
        });
      });
  
      // Filter Search
      if (filterSearch) {
        filterSearch.addEventListener("input", filterValueOptions);
      }
  
      // Load initial column filter options
      function loadFilterOptions() {
        const selectedColumn = columnDropdown.value;
        if (!selectedColumn) return;

        console.log("Fetching unique values for column:", selectedColumn);

        fetch(`/get_unique_values?column=${encodeURIComponent(selectedColumn)}`)
          .then(res => res.json())
          .then(data => {
            const checkboxContainer = document.getElementById("filter-options");
            checkboxContainer.innerHTML = "";  // âœ… only clear checkboxes

            if (data.values.length > 0) {
              data.values.forEach((value, i) => {
                const wrapper = document.createElement("div");
                wrapper.className = 'checkbox-wrapper';

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = `filter-val-${i}`;
                checkbox.value = value;
                checkbox.name = selectedColumn;
                checkbox.addEventListener("change", toggleApplyFilterButton);

                const label = document.createElement("label");
                label.htmlFor = checkbox.id;
                label.textContent = value;

                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                checkboxContainer.appendChild(wrapper);
              });
            } else {
              console.log("No values found for the selected column.");
            }
          })
          .catch(err => console.error("Error fetching unique values:", err));
      }

  
      function toggleApplyFilterButton() {
        const checkboxes = filterOptionsContainer.querySelectorAll("input[type='checkbox']");
        const isAnyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (applyButton) applyButton.disabled = !isAnyChecked;
      }
  
      function filterValueOptions() {
        const searchText = document.getElementById('filter-search').value.trim().toLowerCase();
        const wrappers = document.querySelectorAll('#filter-options .checkbox-wrapper');

        wrappers.forEach(wrapper => {
          const label = wrapper.querySelector('label');
          const labelText = label.textContent.trim().toLowerCase();

          // Check if the searchText is included in the labelText
          if (labelText.includes(searchText)) {
            wrapper.style.display = 'flex'; // Show the option
          } else {
            wrapper.style.display = 'none'; // Hide the option
          }
        });
      }

  
      // Expose apply and clear filter functions globally
      window.applyFilter = function () {
        const selectedColumn = columnDropdown.value;
        const selectedValues = Array.from(
          filterOptionsContainer.querySelectorAll("input[type='checkbox']:checked")
        ).map(cb => cb.value);
  
        if (!selectedColumn || selectedValues.length === 0) return;
  
        const filterParam = encodeURIComponent(selectedValues.join(","));
        window.location.href = `/dashboard?page=1&filter_col=${encodeURIComponent(selectedColumn)}&filter_val=${filterParam}`;
      }
  
      window.clearFilter = function () {
        window.location.href = "/dashboard";
      }
  
      function updateCount(count) {
        if (selectedCountEl) selectedCountEl.innerText = count;
      }
      function uncheckAllFilters() {
        document.querySelectorAll('#filter-options input[type="checkbox"]').forEach(cb => cb.checked = false);
        toggleApplyFilterButton();
      }
    });
  </script>
  
</body>
</html>