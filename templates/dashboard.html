<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Selection Dashboard</title>
  <!-- Link to your external CSS file located in static/style.css -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Include jQuery for convenience -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="paper">
    <h1>Product Selection Dashboard</h1>
    
    <div class="dashboard-header">
      <div id="filter-section" class="p-4">
        <label for="column-select">Choose Column:</label>
        <select id="column-select">
          <!-- Column options will be dynamically inserted here -->
        </select>
  
        <div id="filter-options-container" class="mt-2">
          <input type="text" id="filter-search" placeholder="Search values..." class="mb-2" oninput="filterValueOptions()">
          <div id="filter-options" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px;">
            <!-- Checkboxes will be dynamically inserted here -->
          </div>
          <button id="apply-filter" onclick="applyFilter()" class="btn-primary mt-2" disabled>Apply Filter</button>
          <button onclick="clearFilter()" class="btn-secondary mt-2">Clear Filter</button>
        </div>
      </div>
  
      <div class="right-panel">
        <h2>Selected Products</h2>
        <p id="selected-count">0</p>
      </div>
    </div>
  
    <hr class="my-4">
  
    <form action="/" method="POST" enctype="multipart/form-data" class="mb-4">
      <label class="block mb-2">Upload CSV File:</label>
      <input type="file" name="file" required class="mb-2">
      <button type="submit" class="btn-primary" onclick="localStorage.removeItem('selectedItems');">Upload CSV</button>
    </form>
  
    <a href="{{ url_for('download_sample') }}" class="btn-secondary inline-block mb-4" download>
      ðŸ“¥ Download Sample CSV
    </a>
  
    <!-- Product List -->
    <ul class="card-list">
      {% for item in data %}
      <li class="paper border shadow shadow-large shadow-hover">
        <input type="checkbox" class="select-item" data-item="{{ item['Item Code'] }}"
          {% if item['Item Code'] in selected_items %}checked{% endif %}>
        <img src="{{ item['IMAGE'] }}" alt="Product Image" onerror="this.onerror=null; this.src='https://via.placeholder.com/150';">
        <h2>Item Code: {{ item['Item Code'] }}</h2>
        <p>Lot: {{ item['Lot Number'] }}</p>
        <p>Unit Weight: {{ item['Unit Weight'] }}</p>
        <p>Complexity: {{ item['Complexity Code'] }}</p>
        <p>Group: {{ item['Product Group'] }}</p>
        <p>Stock Value: {{ item['Stock Value'] }}</p>
        <p>Category: {{ item['Product Category Description'] }}</p>
      </li>
      {% endfor %}
    </ul>
  
    <hr>
  
    <!-- Pagination Controls -->
    <div class="pagination">
      {% if current_page > 1 %}
        <a href="{{ url_for('dashboard', page=current_page-1, filter_col=request.args.get('filter_col'), filter_val=request.args.get('filter_val')) }}" class="btn-secondary">Previous</a>
      {% endif %}
      <span>Page {{ current_page }} of {{ total_pages }}</span>
      {% if current_page < total_pages %}
        <a href="{{ url_for('dashboard', page=current_page+1, filter_col=request.args.get('filter_col'), filter_val=request.args.get('filter_val')) }}" class="btn-primary">Next</a>
      {% endif %}
    </div>
  
    <hr>
  
    <!-- Download Selected Button -->
    <button id="downloadSelected" class="btn-primary">Download Selected Products</button>
  </div>

  <script>
    // Injected from Flask (make sure this is above DOMContentLoaded)
    const columnData = JSON.parse('{{ column_data | tojson | safe }}');
    console.log("Available Columns:", columnData)


    document.addEventListener("DOMContentLoaded", function () {
      // Restore saved selections from localStorage (if any)
      let selectedItems = new Set(JSON.parse(localStorage.getItem("selectedItems")) || []);
      const applyButton = document.getElementById("apply-filter");
      const columnDropdown = document.getElementById("column-select");

      if (applyButton) applyButton.disabled = true; // Initially disable
      if (columnDropdown) {
        // Populate column dropdown
        columnData.forEach(col => {
          const option = document.createElement("option");
          option.value = col;
          option.textContent = col;
          columnDropdown.appendChild(option);
        });

        columnDropdown.addEventListener("change", loadFilterOptions);
      }

      function updateCount(count) {
        document.getElementById('selected-count').innerText = count;
      }
      // Update the count on page load
      updateCount(selectedItems.size);
  
      // For each checkbox, check if its data-item value is in the saved set
      document.querySelectorAll(".select-item").forEach((checkbox) => {
        const itemCode = checkbox.getAttribute("data-item");
        if (selectedItems.has(itemCode)) {
          checkbox.checked = true;
        }
        checkbox.addEventListener("change", function () {
          if (this.checked) {
            selectedItems.add(itemCode);
          } else {
            selectedItems.delete(itemCode);
          }
  
          // Save updated selection in localStorage
          localStorage.setItem("selectedItems", JSON.stringify([...selectedItems]));
  
          // Send selection to backend via AJAX
          fetch("{{ url_for('save_selection') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ selected: [...selectedItems] })
          })
          .then(response => response.json())
          .then(data => {
            console.log("Selection saved:", data.message);
            // Check if selectedCount is present in response and update the count
            if (data.selectedCount) {
              updateCount(data.selectedCount);
            }
          })
          .catch(err => {
            console.error("Error in saving selection:", err);
          });
        });
      });
  
      // Function to update selected cou
  
      // Handle Download Selected button click
      const downloadBtn = document.getElementById("downloadSelected");
      if (downloadBtn) {
        downloadBtn.addEventListener("click", function () {
          window.location.href = "{{ url_for('download_selected') }}";
        });
      }
  
      // Apply hover blur effect using JS (if needed)
      const cardList = document.querySelector(".card-list");
      const listItems = document.querySelectorAll(".card-list li");
      listItems.forEach((item) => {
        item.addEventListener("mouseover", function () {
          cardList.classList.add("hover-active");
          item.classList.add("hovered");
        });
        item.addEventListener("mouseleave", function () {
          cardList.classList.remove("hover-active");
          item.classList.remove("hovered");
        });
      });
    });

      // Function to load filter options based on selected column
        // Function to load filter options based on selected column
      function loadFilterOptions() {
        const selectedColumn = document.getElementById("column-select").value;
        if (!selectedColumn) return;

        console.log("Fetching unique values for column:", selectedColumn);  // Debugging line

        fetch(`/get_unique_values?column=${encodeURIComponent(selectedColumn)}`)
          .then(response => response.json())
          .then(data => {
            console.log("Received unique values:", data);  // Debugging line

            // Clear the filter options and checkboxes container
            const filterOptionsContainer = document.getElementById("filter-options");
            filterOptionsContainer.innerHTML = ""; // Clear existing checkboxes

            if (data.values.length > 0) {
              // Generate checkboxes for each unique value
              data.values.forEach(value => {
                const checkboxWrapper = document.createElement("div");
                checkboxWrapper.classList.add("checkbox-wrapper");

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = value;
                checkbox.id = "filter-" + value; // Unique ID for each checkbox
                checkbox.name = selectedColumn;

                // Add event listener to enable/disable "Apply Filter" button
                checkbox.addEventListener("change", toggleApplyFilterButton);

                const label = document.createElement("label");
                label.setAttribute("for", checkbox.id);
                label.textContent = value;

                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);
                filterOptionsContainer.appendChild(checkboxWrapper);
              });
            } else {
              console.log("No values found for the selected column.");
            }
          })
          .catch(error => {
            console.error("Error fetching unique values:", error);
          });
      }

      // Function to toggle the "Apply Filter" button based on checkbox selection
      function toggleApplyFilterButton() {
        const applyButton = document.getElementById("apply-filter");
        const checkboxes = document.querySelectorAll("#filter-options input[type='checkbox']");
        const isAnyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        
        // Enable the "Apply Filter" button if at least one checkbox is checked
        applyButton.disabled = !isAnyChecked;
      }
      function filterValueOptions() {
        const searchQuery = document.getElementById("filter-search").value.toLowerCase();
        const valueSelect = document.getElementById("value-select");
        const options = valueSelect.getElementsByTagName("option");

        for (let option of options) {
          const text = option.textContent || option.innerText;
          option.style.display = text.toLowerCase().includes(searchQuery) ? "" : "none";
        }
      }

      function applyFilter() {
        const selectedColumn = document.getElementById("column-select").value;
        const selectedOptions = Array.from(document.getElementById("filter-options").querySelectorAll('input[type="checkbox"]:checked'));
        const selectedValues = selectedOptions.map(opt => opt.value);

        if (!selectedColumn || selectedValues.length === 0) return;

        // Build the filter parameters to send to the backend
        const filterParam = encodeURIComponent(selectedValues.join(","));
        
        // Update the URL with filter parameters and reload the page to fetch filtered data
        window.location.href = `/dashboard?page=1&filter_col=${encodeURIComponent(selectedColumn)}&filter_val=${filterParam}`;
      }


    function clearFilter() {
      window.location.href = "/dashboard";
    }
  </script>
</body>
</html>